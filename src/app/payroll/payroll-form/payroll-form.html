<div class="payroll-form-container">
  <p-toast />

  <div class="page-header">
    <div class="header-content">
      <h1><i class="pi pi-calculator"></i> Cálculo de Nómina</h1>
      <p>Calcula el salario neto con bonificaciones y deducciones</p>
    </div>
  </div>

  <div class="form-card">
    <p-card>
      <form [formGroup]="payrollForm" (ngSubmit)="onSubmit()">
        <!-- Información Básica -->
        <div class="form-section">
          <h2><i class="pi pi-info-circle"></i> Información Básica</h2>
          <div class="form-grid">
            <div class="form-field">
              <label>Empleado <span class="required">*</span></label>
              <p-select 
                formControlName="employeeId"
                [options]="employees"
                placeholder="Seleccione un empleado"
                [class.p-invalid]="submitted && payrollForm.get('employeeId')?.invalid">
              </p-select>
              @if (submitted && payrollForm.get('employeeId')?.invalid) {
                <small class="p-error">El empleado es requerido</small>
              }
            </div>

            <div class="form-field">
              <label>Período <span class="required">*</span></label>
              <input 
                type="text" 
                formControlName="period"
                placeholder="Ej: Enero 2024"
                [class.p-invalid]="submitted && payrollForm.get('period')?.invalid">
              @if (submitted && payrollForm.get('period')?.invalid) {
                <small class="p-error">El período es requerido</small>
              }
            </div>

            <div class="form-field">
              <label>Salario Base <span class="required">*</span></label>
              <p-inputNumber 
                formControlName="baseSalary"
                mode="currency"
                currency="HNL"
                locale="es-HN"
                [min]="0"
                [class.p-invalid]="submitted && payrollForm.get('baseSalary')?.invalid">
              </p-inputNumber>
              @if (submitted && payrollForm.get('baseSalary')?.invalid) {
                <small class="p-error">El salario base es requerido</small>
              }
            </div>
          </div>
        </div>

        <!-- Bonificaciones -->
        <div class="form-section">
          <h2><i class="pi pi-plus-circle"></i> Bonificaciones</h2>
          <div class="form-grid">
            <div class="form-field">
              <label>Descripción</label>
              <input 
                type="text" 
                formControlName="bonusDescription"
                placeholder="Ej: Bono de productividad">
            </div>
            <div class="form-field">
              <label>Monto</label>
              <p-inputNumber 
                formControlName="bonusAmount"
                mode="currency"
                currency="HNL"
                locale="es-HN"
                [min]="0">
              </p-inputNumber>
            </div>
            <div class="form-field full-width">
              <button 
                type="button"
                pButton 
                label="Agregar Bonificación"
                icon="pi pi-plus"
                class="p-button-outlined"
                (click)="addBonus()">
              </button>
            </div>
          </div>

          @if (bonuses().length > 0) {
            <div class="items-table">
              <p-table [value]="bonuses()" [tableStyle]="{ 'min-width': '50rem' }">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Descripción</th>
                    <th>Monto</th>
                    <th>Acción</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-bonus let-index="rowIndex">
                  <tr>
                    <td>{{ bonus.description }}</td>
                    <td class="bonus-cell">{{ formatCurrency(bonus.amount) }}</td>
                    <td>
                      <button 
                        pButton 
                        icon="pi pi-trash" 
                        class="p-button-rounded p-button-danger p-button-text"
                        (click)="removeBonus(index)">
                      </button>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          }
        </div>

        <!-- Deducciones -->
        <div class="form-section">
          <h2><i class="pi pi-minus-circle"></i> Deducciones</h2>
          <div class="form-grid">
            <div class="form-field">
              <label>Descripción</label>
              <input 
                type="text" 
                formControlName="deductionDescription"
                placeholder="Ej: ISR">
            </div>
            <div class="form-field">
              <label>Monto</label>
              <p-inputNumber 
                formControlName="deductionAmount"
                mode="currency"
                currency="HNL"
                locale="es-HN"
                [min]="0">
              </p-inputNumber>
            </div>
            <div class="form-field full-width">
              <button 
                type="button"
                pButton 
                label="Agregar Deducción"
                icon="pi pi-plus"
                class="p-button-outlined"
                (click)="addDeduction()">
              </button>
            </div>
          </div>

          @if (deductions().length > 0) {
            <div class="items-table">
              <p-table [value]="deductions()" [tableStyle]="{ 'min-width': '50rem' }">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Descripción</th>
                    <th>Monto</th>
                    <th>Acción</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-deduction let-index="rowIndex">
                  <tr>
                    <td>{{ deduction.description }}</td>
                    <td class="deduction-cell">{{ formatCurrency(deduction.amount) }}</td>
                    <td>
                      <button 
                        pButton 
                        icon="pi pi-trash" 
                        class="p-button-rounded p-button-danger p-button-text"
                        (click)="removeDeduction(index)">
                      </button>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          }
        </div>

        <!-- Resumen de Cálculo -->
        <div class="form-section summary-section">
          <h2><i class="pi pi-chart-line"></i> Resumen de Cálculo</h2>
          <div class="summary-card">
            <div class="summary-row">
              <span>Salario Base:</span>
              <strong>{{ formatCurrency(payrollForm.get('baseSalary')?.value || 0) }}</strong>
            </div>
            <div class="summary-row">
              <span>Total Bonificaciones:</span>
              <strong class="bonus-text">{{ formatCurrency(totalBonuses()) }}</strong>
            </div>
            <div class="summary-row">
              <span>Total Deducciones:</span>
              <strong class="deduction-text">{{ formatCurrency(totalDeductions()) }}</strong>
            </div>
            <div class="summary-row total-row">
              <span>Salario Neto:</span>
              <strong class="net-salary-text">{{ formatCurrency(netSalary()) }}</strong>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button 
            type="button"
            pButton 
            label="Cancelar"
            icon="pi pi-times"
            class="p-button-secondary"
            (click)="onCancel()">
          </button>
          <button 
            type="submit"
            pButton 
            label="Calcular y Guardar"
            icon="pi pi-check">
          </button>
        </div>
      </form>
    </p-card>
  </div>
</div>

