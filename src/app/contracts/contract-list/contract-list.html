<div class="contract-list-container">
  <div class="header">
    <h1>Gestión de Contratos</h1>
    <div class="actions">
      <a routerLink="/contratos/nuevo" class="btn-primary">
        <i class="pi pi-plus"></i> Nuevo Contrato
      </a>
      <button class="btn-secondary" (click)="toggleAlertas()">
        <i class="pi pi-bell"></i> 
        Alertas de Vencimiento
        @if (alertasVencimiento().length > 0) {
          <span class="badge">{{ alertasVencimiento().length }}</span>
        }
      </button>
    </div>
  </div>

  @if (mostrarAlertas() && alertasVencimiento().length > 0) {
    <div class="alertas-section">
      <h2>⚠️ Contratos Próximos a Vencer</h2>
      <p-table [value]="alertasVencimiento()" [loading]="loading()" styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th>Empleado</th>
            <th>Tipo</th>
            <th>Fecha Inicio</th>
            <th>Fecha Fin</th>
            <th>Estado</th>
            <th>Días Restantes</th>
            <th>Acciones</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-contrato>
          <tr>
            <td>{{ contrato.nombre_empleado || getNombreEmpleado(contrato.id_empleado) }}</td>
            <td>
              <p-tag [value]="contrato.tipo_contrato" [severity]="getSeverityTipo(contrato.tipo_contrato)"></p-tag>
            </td>
            <td>{{ formatDate(contrato.fecha_inicio) }}</td>
            <td>{{ formatDate(contrato.fecha_fin || '') }}</td>
            <td>
              <p-tag [value]="contrato.estado_vencimiento || 'vigente'" 
                     [severity]="getSeverityVencimiento(contrato.estado_vencimiento)"></p-tag>
            </td>
            <td>
              @if (contrato.dias_restantes !== undefined) {
                <span [class.text-danger]="contrato.dias_restantes < 0"
                      [class.text-warning]="contrato.dias_restantes >= 0 && contrato.dias_restantes <= 7">
                  {{ contrato.dias_restantes < 0 ? 'Vencido' : contrato.dias_restantes + ' días' }}
                </span>
              }
            </td>
            <td>
              <button pButton icon="pi pi-pencil" class="p-button-text p-button-sm" 
                      [routerLink]="['/contratos/editar', contrato.id_contrato]"></button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  }

  <div class="table-section">
    <p-table [value]="contratos()" [loading]="loading()" [paginator]="true" [rows]="10" 
             [globalFilterFields]="['nombre_empleado', 'tipo_contrato']">
      <ng-template pTemplate="caption">
        <div class="table-header">
          <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input type="text" pInputText placeholder="Buscar contratos..." />
          </span>
        </div>
      </ng-template>
      <ng-template pTemplate="header">
        <tr>
          <th>Empleado</th>
          <th>Tipo de Contrato</th>
          <th>Fecha Inicio</th>
          <th>Fecha Fin</th>
          <th>Salario</th>
          <th>Condiciones</th>
          <th>Acciones</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-contrato>
        <tr>
          <td>{{ contrato.nombre_empleado || getNombreEmpleado(contrato.id_empleado) }}</td>
          <td>
            <p-tag [value]="contrato.tipo_contrato" [severity]="getSeverityTipo(contrato.tipo_contrato)"></p-tag>
          </td>
          <td>{{ formatDate(contrato.fecha_inicio) }}</td>
          <td>{{ formatDate(contrato.fecha_fin || '') || 'Permanente' }}</td>
          <td>{{ formatCurrency(contrato.salario) }}</td>
          <td>
            <span [pTooltip]="contrato.condiciones || 'Sin condiciones especiales'" 
                  tooltipPosition="top">
              {{ (contrato.condiciones || 'N/A').substring(0, 30) }}{{ contrato.condiciones && contrato.condiciones.length > 30 ? '...' : '' }}
            </span>
          </td>
          <td>
            <button pButton icon="pi pi-eye" class="p-button-text p-button-sm" 
                    [routerLink]="['/contratos', contrato.id_contrato]"
                    pTooltip="Ver detalles"></button>
            <button pButton icon="pi pi-pencil" class="p-button-text p-button-sm" 
                    [routerLink]="['/contratos/editar', contrato.id_contrato]"
                    pTooltip="Editar"></button>
            <button pButton icon="pi pi-trash" class="p-button-text p-button-sm p-button-danger" 
                    (click)="deleteContrato(contrato)"
                    pTooltip="Eliminar"></button>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center">No hay contratos registrados</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>

